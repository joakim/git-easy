#!/bin/bash

source "/usr/local/lib/gitano"

stash_message="Gitano syncing"
branch=$(branch_get_current)

# Make sure the arguments and conditions are right.
test -z $branch && print "Not currently on a branch" && exit 1

# Check if the branch has been published.

# Stash changes if the working directory is dirty.
state="$(working_directory_state)"
if test $state -ne $STATE_CLEAN; then
  print "Saving local changes"
  branch_stash $stash_message
  stashed=true
fi

# Fetch and rebase changes from the remote, then push local changes.
git fetch origin && git rebase origin/$branch && git push origin $branch

# If local changes were stashed, unstash them.
if test -n stashed; then
  git stash pop
  # @todo Safer unstash?
  # stash_index="$(branch_get_stash_index $branch_to $stash_message)"
  # if [ stash_index != "" ]; then
  #   print "Restoring local changes"
  #   branch_unstash $stash_index
  # fi
fi
